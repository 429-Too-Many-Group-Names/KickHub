{% extends "base.html" %}
{% load static %}

{% block title %}{{ item.name }} | KickHub{% endblock %}

{% block content %}
<p style="text-align: left; margin:1rem 0;">
  <a class="text-decoration" href="{% url 'index' %}">← Back to Catalog</a>
</p>

<section style="display:grid; gap:2rem; grid-template-columns:1fr 1fr;">
  <!-- Product Image -->
  <div>
    {% if item.image %}
      <img src="{{ item.image.url }}" alt="{{ item.name }}" style="max-width:100%; border-radius:8px;">
    {% else %}
      <img src="{% static 'images/default_placeholder.png' %}" alt="No image available" style="max-width:100%; border-radius:8px;">
    {% endif %}
  </div>

  <!-- Product Info -->
  <div style="text-align: left;">
    <h1 style="margin:0 0 .5rem;">{{ item.name }}</h1>
    <p style="margin:.25rem 0; color:#666;">Color: {{ item.color }}</p>
    <p style="margin:.25rem 0; color:#666;">Release date: {{ item.releaseDate }}</p>
    <p style="font-size:1.25rem; font-weight:700; margin:.75rem 0;">{{ item.price_display }}</p>

    {% if available_sizes %}
      <form class="add-to-cart-form" method="post" action="{% url 'add_to_cart' %}" style="display:grid; gap:.75rem; max-width:320px;">
        {% csrf_token %}
        <input type="hidden" name="item_id" value="{{ item.id }}">

        <label for="size">Size</label>
        <select id="size" name="size_id" required>
          {% for s in available_sizes %}
            <option value="{{ s.id }}" data-qty="{{ s.quantity }}">{{ s.size }} — {{ s.quantity }} in stock</option>
          {% endfor %}
        </select>

        <label for="qty">Quantity</label>
        <input id="qty" type="number" name="quantity" value="1" min="1">
        <button type="submit">Add to Cart</button>
      </form>
    {% else %}
      <p><strong>Out of stock.</strong></p>
      <button type="button" disabled>Out of Stock</button>
    {% endif %}

    <hr style="margin:1.5rem 0;">
    <article style="line-height:1.6;">
      {{ item.description|linebreaks }}
    </article>
  </div>
</section>

<script>
  // Automatically cap quantity input to the available stock
  (function() {
    const sizeSel = document.getElementById('size');
    const qtyInput = document.getElementById('qty');
    if (!sizeSel || !qtyInput) return;
    function updateMax() {
      const opt = sizeSel.options[sizeSel.selectedIndex];
      const max = opt ? parseInt(opt.getAttribute('data-qty') || '1', 10) : 1;
      qtyInput.max = Math.max(1, max);
      if (parseInt(qtyInput.value, 10) > max) qtyInput.value = max;
    }
    sizeSel.addEventListener('change', updateMax);
    updateMax();
  })();
</script>
{% endblock %}
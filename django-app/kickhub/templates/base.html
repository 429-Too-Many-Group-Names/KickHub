{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{% block title %}KickHub{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="center-rectangle">
        <nav class="navbar">
            <ul class="nav-links">
                <li><a href="{% url 'index' %}" class="site-name">KickHub</a></li>
                {% if user.is_authenticated %}
                <li><a href="{% url 'profile' %}" class="nav-button">Profile</a></li>
                <li><a href="{% url 'cart' %}" class="nav-button">Cart</a></li>
                <li>
                    <form action="{% url 'account_logout' %}" method="post" class="logout-form">
                        {% csrf_token %}
                        <button type="submit" class="nav-button logout-button">Logout</button>
                    </form>
                </li>
                {% else %}
                <li><a href="{% provider_login_url 'google' %}" class="nav-button logout-button">Login</a></li>
                {% endif %}
            </ul>
            <div id="toast" class="toast">Item added to cart!</div>
        </nav>
        <hr>
    
        {% block content %}{% endblock %}
    </div>
    
</body>
{% block scripts %}
<script src="{% static 'main.js' %}"></script>

<!-- ADDED: Client-side live filtering (works on pages with product cards) -->
<script>
(function () {
  const input = document.getElementById('searchInput');
  const noResults = document.getElementById('noResults');
  if (!input) return;

  function getCards() {
    return Array.from(document.querySelectorAll('.card-container > .card'));
  }

  function buildIndex(card) {
    if (card.dataset.searchIndex) return card.dataset.searchIndex;
    const blob = (card.textContent || '').toLowerCase().replace(/\s+/g, ' ').trim();
    card.dataset.searchIndex = blob;
    return blob;
  }

  function matches(card, query) {
    const q = query.toLowerCase().trim();
    if (!q) return true;
    return buildIndex(card).includes(q);
  }

  function filterCards(query) {
    const cards = getCards();
    let shown = 0;
    cards.forEach(card => {
      const show = matches(card, query);
      card.style.display = show ? '' : 'none';
      if (show) shown++;
    });
    if (noResults) noResults.style.display = shown === 0 ? '' : 'none';
  }

  input.addEventListener('input', () => filterCards(input.value));
  if (input.value) filterCards(input.value);
})();

function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.classList.add("show");
  
  setTimeout(() => {
    toast.classList.remove("show");
  }, 3000); // hides after 3 seconds
}

document.querySelectorAll('.add-to-cart-form').forEach(form => {
  form.addEventListener('submit', function(e) {
    e.preventDefault(); // stop page reload

    const formData = new FormData(this);

    fetch(this.action, {
      method: 'POST',
      headers: {
        'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast(data.message || "Item added to cart!");
      } else if (data.error) {
        showToast(data.error || "Error adding item.");
      }
    })
    .catch(err => {
      console.error(err);
      showToast("Something went wrong.");
    });
  });
});

</script>

{% endblock %}

</html>

{% extends "base.html" %}
{% load static %}

{% block title %}KickHub{% endblock %}

{% block content %}

<!-- Sticky header row: price filter (left) + Catalog (center) + search (right) -->
<div class="catalog-header-wrapper">
  <div class="catalog-header">
    <!-- LEFT: Price filter dropdown -->
    <div class="catalog-toolbar-left">
      <label for="priceFilter" class="sr-only">Price filter</label>
      <select id="priceFilter" class="price-filter">
        <option value="">Price filter</option>
        <option value="low_to_high">Price: Low to High</option>
        <option value="high_to_low">Price: High to Low</option>
        <option value="in_stock">In Stock Only</option>
      </select>
    </div>

    <!-- CENTER: Catalog title -->
    <h2 class="catalog-title">Catalog</h2>

    <!-- RIGHT: Rounded search bar -->
    <div class="catalog-toolbar-right">
      <form method="get" action="" class="search-form">
        <input
          type="text"
          name="q"
          id="searchInput"
          class="search-input"
          placeholder="Search shoes..."
          value="{{ request.GET.q|default_if_none:'' }}"
        >
      </form>
    </div>
  </div>

  <!-- Thin line under the header row -->
  <hr class="catalog-divider">
</div>

<div class="card-container">
  {% for entry in items %}
  <div
    class="card"
    data-price="{{ entry.item.price }}"
    data-in-stock="{% if entry.sizes %}1{% else %}0{% endif %}"
  >
    <!-- Clickable link to the detail page -->
    <a href="{% url 'item_detail' entry.item.slug %}">
      {% if entry.item.image %}
        <img src="{{ entry.item.image.url }}" alt="{{ entry.item.name }}" class="card-img">
      {% else %}
        <img src="{% static 'images/default_placeholder.png' %}" alt="No image available" class="card-img">
      {% endif %}
      <h3>{{ entry.item.brand }} {{ entry.item.model }}</h3>

      <p><strong>${{ entry.item.price|floatformat:2 }}</strong></p>
    </a>



    <form class="add-to-cart-form" method="post" action="{% url 'add_to_cart' %}">
      {% csrf_token %}
      <input type="hidden" name="item_id" value="{{ entry.item.id }}">

      {% if entry.sizes %}
        <label for="size-{{ entry.item.id }}">Size:</label>
        <select name="size_id" id="size-{{ entry.item.id }}">
          {% for size in entry.sizes %}
          <option value="{{ size.id }}">
            {{ size.size }} ({{ size.quantity }} available)
          </option>
          {% endfor %}
        </select>
        <button type="submit">Add to Cart</button>
      {% else %}
        <span>No sizes available</span>
      {% endif %}
    </form>
  </div>
  {% empty %}
    <p>No items available.</p>
  {% endfor %}
</div>

<p id="noResults" style="display:none; margin-top: 1rem;">
  No matching items found.
</p>

<!-- PAGE-SPECIFIC JS: search + price filter -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchInput');
  const priceFilter = document.getElementById('priceFilter');
  const container = document.querySelector('.card-container');
  const cards = Array.from(container.querySelectorAll('.card'));
  const noResults = document.getElementById('noResults');

  function applyFilters() {
    const q = (searchInput.value || '').toLowerCase().trim();
    const filter = priceFilter.value;
    let visible = [];

    // First: filter by search text + in stock option
    cards.forEach(card => {
      const text = (card.textContent || '').toLowerCase();
      const price = parseFloat(card.dataset.price || '0');
      const inStock = card.dataset.inStock === '1';

      let show = true;

      if (q && !text.includes(q)) {
        show = false;
      }

      if (filter === 'in_stock' && !inStock) {
        show = false;
      }

      card.style.display = show ? '' : 'none';

      if (show) {
        visible.push({ el: card, price });
      }
    });

    // Then: sort visible ones by price if selected
    if (filter === 'low_to_high' || filter === 'high_to_low') {
      visible.sort((a, b) => {
        return filter === 'low_to_high'
          ? a.price - b.price
          : b.price - a.price;
      });

      visible.forEach(obj => container.appendChild(obj.el));
    }

    if (noResults) {
      noResults.style.display = visible.length === 0 ? '' : 'none';
    }
  }

  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
  }
  if (priceFilter) {
    priceFilter.addEventListener('change', applyFilters);
  }

  // Initial run (covers pre-filled ?q=... in URL)
  applyFilters();
});
</script>


<script>
function showToast(message, duration=3000) {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.classList.add("show"), 50);
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => container.removeChild(toast), 300);
    }, duration);
}

// Display Django messages
{% if messages %}
    {% for message in messages %}
        document.querySelectorAll('.toast-container').forEach(container => {
        showToast(container, "{{ message }}");
    {% endfor %}
{% endif %}
</script>


<p id="noResults" style="display:none; margin-top: 1rem;">
  No matching items found.
</p>

<!-- PAGE-SPECIFIC JS: search + price filter -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const searchInput = document.getElementById('searchInput');
  const priceFilter = document.getElementById('priceFilter');
  const container = document.querySelector('.card-container');
  const cards = Array.from(container.querySelectorAll('.card'));
  const noResults = document.getElementById('noResults');

  function applyFilters() {
    const q = (searchInput.value || '').toLowerCase().trim();
    const filter = priceFilter.value;
    let visible = [];

    // First: filter by search text + in stock option
    cards.forEach(card => {
      const text = (card.textContent || '').toLowerCase();
      const price = parseFloat(card.dataset.price || '0');
      const inStock = card.dataset.inStock === '1';

      let show = true;

      if (q && !text.includes(q)) {
        show = false;
      }

      if (filter === 'in_stock' && !inStock) {
        show = false;
      }

      card.style.display = show ? '' : 'none';

      if (show) {
        visible.push({ el: card, price });
      }
    });

    // Then: sort visible ones by price if selected
    if (filter === 'low_to_high' || filter === 'high_to_low') {
      visible.sort((a, b) => {
        return filter === 'low_to_high'
          ? a.price - b.price
          : b.price - a.price;
      });

      visible.forEach(obj => container.appendChild(obj.el));
    }

    if (noResults) {
      noResults.style.display = visible.length === 0 ? '' : 'none';
    }
  }

  if (searchInput) {
    searchInput.addEventListener('input', applyFilters);
  }
  if (priceFilter) {
    priceFilter.addEventListener('change', applyFilters);
  }

  // Initial run (covers pre-filled ?q=... in URL)
  applyFilters();
});
</script>


<script>
function showToast(message, duration=3000) {
    const container = document.getElementById("toast-container");
    if (!container) return;

    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    container.appendChild(toast);

    setTimeout(() => toast.classList.add("show"), 50);
    setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => container.removeChild(toast), 300);
    }, duration);
}

// Display Django messages
{% if messages %}
    {% for message in messages %}
        document.querySelectorAll('.toast-container').forEach(container => {
        showToast(container, "{{ message }}");
    {% endfor %}
{% endif %}
</script>

{% endblock %}
